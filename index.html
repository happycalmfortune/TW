<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QÁ∂øÊÑõÁõ£Êéß</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'ÂæÆËªüÊ≠£ÈªëÈ´î', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .api-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .api-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .api-section input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .api-section input:focus {
            outline: none;
            border-color: #3498db;
        }

        .portfolio-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .summary-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .summary-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .summary-card.positive {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        }

        .summary-card.negative {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 20px;
        }

        .portfolio-table {
            width: 100%;
            min-width: 800px;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .portfolio-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .portfolio-table td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .portfolio-table tr:hover {
            background: #f8f9fa;
        }

        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .price-positive {
            color: #27ae60;
            font-weight: 600;
        }

        .price-negative {
            color: #e74c3c;
            font-weight: 600;
        }

        .password-section {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .password-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .password-section input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e1e8ed;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .password-section input:focus {
            outline: none;
            border-color: #3498db;
        }

        .password-error {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 0.9em;
            display: none;
        }

        .main-content {
            display: none;
        }

        .main-content.authenticated {
            display: block;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .stock-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .stock-symbol {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .password-section {
                margin: 50px auto;
                padding: 30px 20px;
                max-width: 90%;
            }

            .password-section h2 {
                font-size: 1.5em;
            }

            body {
                padding: 5px;
            }

            .container {
                border-radius: 10px;
            }

            .main-content {
                padding: 15px;
            }
            
            .header {
                padding: 20px 15px;
            }

            .header h1 {
                font-size: 1.5em;
                margin-bottom: 8px;
            }

            .header p {
                font-size: 1em;
            }

            .portfolio-summary {
                grid-template-columns: 1fr;
                gap: 15px;
                margin-bottom: 20px;
            }

            .summary-card {
                padding: 20px;
            }

            .summary-card h3 {
                font-size: 0.85em;
            }

            .summary-card .value {
                font-size: 1.5em;
            }

            .btn {
                width: 100%;
                margin-right: 0;
                margin-bottom: 10px;
            }

            .portfolio-table {
                font-size: 0.8em;
                min-width: 700px;
            }

            .portfolio-table th,
            .portfolio-table td {
                padding: 8px 6px;
            }

            .portfolio-table th {
                font-size: 0.85em;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3em;
            }

            .portfolio-table {
                font-size: 0.75em;
                min-width: 650px;
            }

            .portfolio-table th,
            .portfolio-table td {
                padding: 6px 4px;
            }
        }
    </style>
</head>
<body>
    <div id="passwordSection" class="password-section">
        <h2>üîí Ë´ãËº∏ÂÖ•ÂØÜÁ¢º</h2>
        <input type="password" id="passwordInput" placeholder="Ë´ãËº∏ÂÖ•ÂØÜÁ¢º" autocomplete="off">
        <button class="btn" onclick="checkPassword()">Á¢∫Ë™ç</button>
        <div class="password-error" id="passwordError">ÂØÜÁ¢ºÈåØË™§ÔºåË´ãÈáçÊñ∞Ëº∏ÂÖ•</div>
    </div>

    <div class="container" id="mainContainer" style="display: none;">
        <div class="header">
            <h1>üìà QÁ∂øÊÑõÁõ£Êéß</h1>
            <p>ÊØèÂ§©ÈÉΩÂú®Áõ£Êéß</p>
        </div>

        <div class="main-content authenticated">
            <div id="loadingSection" style="display: none;">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Ê≠£Âú®ÂèñÂæóÊúÄÊñ∞ÂÉπÊ†º...</p>
                </div>
            </div>

            <div id="portfolioSection" style="display: none;">
                <div class="portfolio-summary" id="portfolioSummary"></div>
                
                <div style="margin-bottom: 20px;">
                    <button class="btn" onclick="refreshPrices()">üîÑ Êõ¥Êñ∞ÂÉπÊ†º</button>
                </div>

                <div class="table-wrapper">
                    <table class="portfolio-table">
                        <thead>
                            <tr>
                                <th>ËÇ°Á•®ÂêçÁ®±</th>
                                <th>‰ª£Ëôü</th>
                                <th>Êï∏Èáè</th>
                                <th>ÊàêÊú¨</th>
                                <th>Âπ≥ÂùáÊàêÊú¨</th>
                                <th>ÁèæÂÉπ</th>
                                <th>ÁèæÂÄº</th>
                                <th>ÊêçÁõä</th>
                                <th>Â†±ÈÖ¨Áéá</th>
                            </tr>
                        </thead>
                        <tbody id="portfolioTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Password protection
        const CORRECT_PASSWORD = 'a45994599';

        function checkPassword() {
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            const passwordSection = document.getElementById('passwordSection');
            const mainContainer = document.getElementById('mainContainer');

            if (passwordInput.value === CORRECT_PASSWORD) {
                // Correct password - hide password form and show main content
                passwordSection.style.display = 'none';
                mainContainer.style.display = 'block';
                passwordError.style.display = 'none';
                // Store authentication in sessionStorage
                sessionStorage.setItem('authenticated', 'true');
                // Auto-fetch prices after authentication
                fetchAllPrices();
            } else {
                // Wrong password - show error
                passwordError.style.display = 'block';
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        // Check if already authenticated in this session
        if (sessionStorage.getItem('authenticated') === 'true') {
            document.getElementById('passwordSection').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            // Auto-fetch prices if already authenticated
            setTimeout(() => {
                if (typeof fetchAllPrices === 'function') {
                    fetchAllPrices();
                }
            }, 100);
        }

        // Allow Enter key to submit password
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('passwordInput');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        checkPassword();
                    }
                });
                passwordInput.focus();
            }
        });

        // Pre-populated portfolio data (5 Taiwan stocks)
        const portfolio = [
            {
                symbol: '0050',
                name: 'ÂÖÉÂ§ßÂè∞ÁÅ£50',
                quantity: 46020,
                avgCost: 38.2476, // ÊØèËÇ°Âπ≥ÂùáÊàêÊú¨
                costBasis: Math.round(38.2476 * 46020) // Á∏ΩÊàêÊú¨ÔºàÊñ∞Âè∞Âπ£ÔºåÂπ≥ÂùáÊàêÊú¨ √ó Êï∏ÈáèÔºåÂõõÊç®‰∫îÂÖ•Ëá≥Êï¥Êï∏Ôºâ
            },
            {
                symbol: '006208',
                name: 'ÂØåÈÇ¶Âè∞50',
                quantity: 19552,
                avgCost: 87.3973,
                costBasis: Math.round(87.3973 * 19552) // Á∏ΩÊàêÊú¨ÔºàÊñ∞Âè∞Âπ£ÔºåÂπ≥ÂùáÊàêÊú¨ √ó Êï∏ÈáèÔºåÂõõÊç®‰∫îÂÖ•Ëá≥Êï¥Êï∏Ôºâ
            },
            {
                symbol: '00878',
                name: 'ÂúãÊ≥∞Ê∞∏Á∫åÈ´òËÇ°ÊÅØ',
                quantity: 52657,
                avgCost: 17.1878,
                costBasis: Math.round(17.1878 * 52657) // Á∏ΩÊàêÊú¨ÔºàÊñ∞Âè∞Âπ£ÔºåÂπ≥ÂùáÊàêÊú¨ √ó Êï∏ÈáèÔºåÂõõÊç®‰∫îÂÖ•Ëá≥Êï¥Êï∏Ôºâ
            },
            {
                symbol: '3653',
                name: 'ÂÅ•Á≠ñ',
                quantity: 50,
                avgCost: 2513.56,
                costBasis: Math.round(2513.56 * 50) // Á∏ΩÊàêÊú¨ÔºàÊñ∞Âè∞Âπ£ÔºåÂπ≥ÂùáÊàêÊú¨ √ó Êï∏ÈáèÔºåÂõõÊç®‰∫îÂÖ•Ëá≥Êï¥Êï∏Ôºâ
            },
            {
                symbol: '6492',
                name: 'ÁîüËèØÁßë',
                quantity: 10000,
                avgCost: 57.762,
                costBasis: Math.round(57.762 * 10000) // Á∏ΩÊàêÊú¨ÔºàÊñ∞Âè∞Âπ£ÔºåÂπ≥ÂùáÊàêÊú¨ √ó Êï∏ÈáèÔºåÂõõÊç®‰∫îÂÖ•Ëá≥Êï¥Êï∏Ôºâ
            }
        ];

        let currentPrices = {};

        // Function to fetch Taiwan stock price from EODHD
        async function fetchTWStockPrice(symbol, apiKey) {
            const cleanSymbol = symbol.replace('.TW', '').replace('.TWO', '');
            
            // Try different symbol formats (padded and unpadded) and exchanges (.TW and .TWO)
            const symbolFormats = [];
            const exchanges = ['.TW', '.TWO']; // Try main board and OTC
            
            // If symbol is 4 digits, try both padded (0XXXX) and unpadded
            if (/^\d{4}$/.test(cleanSymbol)) {
                symbolFormats.push(cleanSymbol); // Try as-is (e.g., 6492)
                symbolFormats.push(cleanSymbol.padStart(5, '0')); // Try padded (e.g., 06492)
            } else {
                symbolFormats.push(cleanSymbol);
            }
            
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            // Try today first, then yesterday if today fails
            const dates = [today, yesterday];
            
            // Try each symbol format and exchange combination
            for (const exchange of exchanges) {
                for (const symbolFormat of symbolFormats) {
                    for (const date of dates) {
                        const dateStr = date.toISOString().split('T')[0];
                        const url = `https://eodhistoricaldata.com/api/eod/${symbolFormat}${exchange}?api_token=${apiKey}&from=${dateStr}&to=${dateStr}&fmt=json`;
                        
                        try {
                            const response = await fetch(url);
                            
                            if (!response.ok) {
                                continue;
                            }
                            
                            const data = await response.json();
                            
                            // Check for error messages in response
                            if (data.error) {
                                continue; // Try next format/date
                            }
                            
                            if (Array.isArray(data) && data.length > 0) {
                                const result = data[0];
                                return {
                                    symbol: symbol,
                                    price: parseFloat(result.close),
                                    date: result.date,
                                    open: parseFloat(result.open),
                                    high: parseFloat(result.high),
                                    low: parseFloat(result.low),
                                    volume: parseInt(result.volume)
                                };
                            }
                        } catch (error) {
                            // Try next date/format
                            continue;
                        }
                    }
                }
            }
            
            // If both dates fail, try getting latest available data with each format and exchange
            for (const exchange of exchanges) {
                for (const symbolFormat of symbolFormats) {
                    const url = `https://eodhistoricaldata.com/api/eod/${symbolFormat}${exchange}?api_token=${apiKey}&period=d&fmt=json&order=d`;
                    
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            continue; // Try next format
                        }
                        
                        const data = await response.json();
                        
                        // Check for error messages
                        if (data.error) {
                            continue; // Try next format
                        }
                        
                        if (Array.isArray(data) && data.length > 0) {
                            const result = data[0];
                            return {
                                symbol: symbol,
                                price: parseFloat(result.close),
                                date: result.date,
                                open: parseFloat(result.open),
                                high: parseFloat(result.high),
                                low: parseFloat(result.low),
                                volume: parseInt(result.volume)
                            };
                        }
                    } catch (error) {
                        // Try next format
                        continue;
                    }
                }
            }
            
            throw new Error(`ÁÑ°Ê≥ïÂèñÂæó ${symbol} ÁöÑÂÉπÊ†ºË≥áÊñô„ÄÇË©≤ËÇ°Á•®ÂèØËÉΩÂ∑≤‰∏ãÂ∏Ç„ÄÅÊö´ÂÅú‰∫§ÊòìÔºåÊàñ‰∏çÂú® EODHD Ë≥áÊñôÂ∫´‰∏≠„ÄÇÂ∑≤ÂòóË©¶Ê†ºÂºèÔºö${cleanSymbol}.TW, ${cleanSymbol.padStart(5, '0')}.TW, ${cleanSymbol}.TWO, ${cleanSymbol.padStart(5, '0')}.TWO`);
        }

        // Function to fetch all prices
        async function fetchAllPrices() {
            const apiKey = '68f8b83eee9586.92066600'; // Hardcoded API key

            const loadingSection = document.getElementById('loadingSection');
            const portfolioSection = document.getElementById('portfolioSection');
            
            loadingSection.style.display = 'block';
            portfolioSection.style.display = 'none';

            currentPrices = {};
            const errors = [];

            try {
                for (const stock of portfolio) {
                    try {
                        const priceData = await fetchTWStockPrice(stock.symbol, apiKey);
                        currentPrices[stock.symbol] = priceData;
                        // Add delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 500));
                    } catch (error) {
                        errors.push(error.message);
                    }
                }

                loadingSection.style.display = 'none';
                portfolioSection.style.display = 'block';
                
                displayPortfolio(errors);
            } catch (error) {
                loadingSection.style.display = 'none';
                alert(`Error: ${error.message}`);
            }
        }

        // Function to display portfolio
        function displayPortfolio(errors) {
            const tableBody = document.getElementById('portfolioTableBody');
            const summaryDiv = document.getElementById('portfolioSummary');
            
            let totalCostBasis = 0;
            let totalCurrentValue = 0;
            let totalProfit = 0;

            let tableHTML = '';

            portfolio.forEach(stock => {
                const priceData = currentPrices[stock.symbol];
                
                if (!priceData) {
                    tableHTML += `<tr>
                        <td><span class="stock-name">${stock.name}</span></td>
                        <td><span class="stock-symbol">${stock.symbol}</span></td>
                        <td>${stock.quantity}</td>
                        <td>NT$ ${stock.costBasis.toLocaleString()}</td>
                        <td>NT$ ${stock.avgCost.toLocaleString()}</td>
                        <td colspan="4" class="error">ÂÉπÊ†ºË≥áÊñôÁÑ°Ê≥ïÂèñÂæó</td>
                    </tr>`;
                    totalCostBasis += stock.costBasis;
                    return;
                }

                const currentPrice = priceData.price;
                // Apply multiplier based on stock symbol: 0050, 006208, 00878 use 0.99758; 3653, 6492 use 0.99558
                const multiplier = (stock.symbol === '0050' || stock.symbol === '006208' || stock.symbol === '00878') ? 0.99758 : 0.99558;
                const currentValue = currentPrice * stock.quantity * multiplier;
                const profit = currentValue - stock.costBasis;
                const returnPercent = (profit / stock.costBasis) * 100;

                totalCostBasis += stock.costBasis;
                totalCurrentValue += currentValue;
                totalProfit += profit;

                const profitClass = profit >= 0 ? 'price-positive' : 'price-negative';
                const returnClass = returnPercent >= 0 ? 'price-positive' : 'price-negative';

                tableHTML += `<tr>
                    <td><span class="stock-name">${stock.name}</span></td>
                    <td><span class="stock-symbol">${stock.symbol}</span></td>
                    <td>${stock.quantity}</td>
                    <td>NT$ ${stock.costBasis.toLocaleString()}</td>
                    <td>NT$ ${stock.avgCost.toLocaleString()}</td>
                    <td>NT$ ${currentPrice.toFixed(2)}</td>
                    <td>NT$ ${currentValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="${profitClass}">NT$ ${profit >= 0 ? '+' : ''}${profit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    <td class="${returnClass}">${returnPercent >= 0 ? '+' : ''}${returnPercent.toFixed(2)}%</td>
                </tr>`;
            });

            tableBody.innerHTML = tableHTML;

            // Display summary
            const totalReturnPercent = (totalProfit / totalCostBasis) * 100;
            const summaryClass = totalProfit >= 0 ? 'positive' : 'negative';

            summaryDiv.innerHTML = `
                <div class="summary-card">
                    <h3>Á∏ΩÊàêÊú¨</h3>
                    <div class="value">NT$ ${totalCostBasis.toLocaleString()}</div>
                </div>
                <div class="summary-card">
                    <h3>ÁèæÂÄº</h3>
                    <div class="value">NT$ ${totalCurrentValue.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="summary-card ${summaryClass}">
                    <h3>Á∏ΩÊêçÁõä</h3>
                    <div class="value">NT$ ${totalProfit >= 0 ? '+' : ''}${totalProfit.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                </div>
                <div class="summary-card ${summaryClass}">
                    <h3>Á∏ΩÂ†±ÈÖ¨Áéá</h3>
                    <div class="value">${totalReturnPercent >= 0 ? '+' : ''}${totalReturnPercent.toFixed(2)}%</div>
                </div>
            `;

            // Show errors if any
            if (errors.length > 0) {
                const errorHTML = `<div class="error">
                    <h4>‚ö†Ô∏è ÁôºÁîüÈåØË™§Ôºö</h4>
                    <ul>
                        ${errors.map(error => `<li>${error}</li>`).join('')}
                    </ul>
                </div>`;
                summaryDiv.insertAdjacentHTML('afterend', errorHTML);
            }
        }

        // Function to refresh prices
        function refreshPrices() {
            fetchAllPrices();
        }

        // Function to export to CSV
        function exportToCSV() {
            let csv = 'Stock Name,Symbol,Quantity,Cost Basis,Avg Cost,Current Price,Current Value,Profit/Loss,Return %\n';
            
            portfolio.forEach(stock => {
                const priceData = currentPrices[stock.symbol];
                
                if (!priceData) {
                    csv += `${stock.name},${stock.symbol},${stock.quantity},${stock.costBasis},${stock.avgCost},N/A,N/A,N/A,N/A\n`;
                    return;
                }

                const currentPrice = priceData.price;
                // Apply multiplier based on stock symbol: 0050, 006208, 00878 use 0.99758; 3653, 6492 use 0.99558
                const multiplier = (stock.symbol === '0050' || stock.symbol === '006208' || stock.symbol === '00878') ? 0.99758 : 0.99558;
                const currentValue = currentPrice * stock.quantity * multiplier;
                const profit = currentValue - stock.costBasis;
                const returnPercent = (profit / stock.costBasis) * 100;

                csv += `${stock.name},${stock.symbol},${stock.quantity},${stock.costBasis},${stock.avgCost},${currentPrice.toFixed(2)},${currentValue.toFixed(2)},${profit.toFixed(2)},${returnPercent.toFixed(2)}%\n`;
            });

            // Add totals
            let totalCostBasis = 0;
            let totalCurrentValue = 0;
            portfolio.forEach(stock => {
                totalCostBasis += stock.costBasis;
                const priceData = currentPrices[stock.symbol];
                if (priceData) {
                    // Apply multiplier based on stock symbol: 0050, 006208, 00878 use 0.99758; 3653, 6492 use 0.99558
                    const multiplier = (stock.symbol === '0050' || stock.symbol === '006208' || stock.symbol === '00878') ? 0.99758 : 0.99558;
                    totalCurrentValue += priceData.price * stock.quantity * multiplier;
                }
            });
            const totalProfit = totalCurrentValue - totalCostBasis;
            const totalReturnPercent = (totalProfit / totalCostBasis) * 100;

            csv += `\nTotal,,,${totalCostBasis},,${totalCurrentValue.toFixed(2)},${totalProfit.toFixed(2)},${totalReturnPercent.toFixed(2)}%\n`;

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `taiwan_portfolio_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Auto-fetch prices on page load (only if authenticated)
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('authenticated') === 'true') {
                fetchAllPrices();
            }
        });
    </script>
</body>
</html>

